<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Process Smil - Administration Guide</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <link href="../../css/extra.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Process SMIL Workflow Operation", url: "#_top", children: [
              {title: "Description", url: "#description" },
              {title: "Configuration Details", url: "#configuration-details" },
              {title: "Parameter Table", url: "#parameter-table" },
              {title: "Operation Example", url: "#operation-example" },
              {title: "Note: (Very Important)", url: "#note-very-important" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../javascript/extra.js"></script>
      <script src="../../javascript/popper.js"></script>
      <script src="../../javascript/tippy.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../publication-to-workspace-woh/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../publication-to-workspace-woh/" class="btn btn-xs btn-link">
        Publication to Workspace
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../probe-resolution-woh/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../probe-resolution-woh/" class="btn btn-xs btn-link">
        Probe Resolution
      </a>
    </div>
    
  </div>

    

    <h1 id="process-smil-workflow-operation">Process SMIL Workflow Operation</h1>
<p>ID: <code>process-smil</code></p>
<h2 id="description">Description</h2>
<p>The ProcessSmilWorkflowHandler is used to edit media files using descriptions from a SMIL file.
The SMIL file is typically generated by the editor or it can be constructed and uploaded.
It contains names of one or more source tracks and a list of selected clips defined by
in/out points in ms in the source tracks.
It will concatenate all the clips from the source tracks according to the in/out points and encode the result into
multiple target videos using a list of encoding profiles.
In addition, the target videos are optionally tagged with the name of the encoding profiles.</p>
<p>The Video editor produces a SMIL file and by default will also encode one set of edited videos
targets as an intermediate format to be used to do segmentation and then used as source to generate multiple delivery
formats.
This workflow operation is used to bypass the generation of the temporary targets and generate the delivery formats
directly.
Subsequent workflow operations can select the highest quality source medium by tags and flavors.
This operation saves the encoding time of one set of full length video and allows concurrent
processing of multiple independent FFmpeg operations.</p>
<p>To use this operation with the editor, the following must be added to the <a href="../editor-woh/">editor</a> workflow operation
to bypass the video editor encoding,</p>
<pre><code class="language-xml">&lt;configuration key=&quot;skip-processing&quot;&gt;true&lt;/configuration&gt;
</code></pre>
<h2 id="configuration-details">Configuration Details</h2>
<p>Currently, there is only one transition type, which is "fade to black".
The edited video will fade in from black with a fade-out/fade-in for each clip transition and a fade out at the end.
The transition duration is a 2 second fade, configured in org.opencastproject.composer.impl.ComposerServiceImpl.cfg.
In the future, each transition can be configurable as a SMIL element.</p>
<p>The SMIL file can use more than one source video, but the caller has to take care that the dimension of
all the source videos are the same.
This workflow will generate one independent FFmpeg operation per SMIL paramgroup (based on source) regardless
of the number of target outputs.</p>
<p>This workflow can handle each source flavor selector independently.
eg: Each source selector can have its own set of encoding profiles, target tags and flavors.
The parameters for each configuration, such as flavor are separated into sections by "<strong>;</strong>".
E
ach source media selector can have its own sets of encoding profile ids (one for each target recording)
and target tags,
as well as its own set of target tags and flavors, defined as a comma delimited list.</p>
<p>As an example, using presenter/source and presentation/source as uploaded media.
eg:</p>
<pre><code class="language-xml"> &lt;configuration key=&quot;source-flavors&quot;&gt;*/source&lt;/configuration&gt;
</code></pre>
<p>One source selector means that all the matching recording will be processed the same way.</p>
<pre><code class="language-xml"> &lt;configuration key=&quot;source-flavors&quot;&gt;presenter/source;presentation/source&lt;/configuration&gt;
</code></pre>
<p>Two different source selectors separated by semicolons means that all the matching recordings in the
first selector will be processed according to the parameters in the first
section and the all the
matching recordings in the second selector will be processed according to the parameters in next section
of the other configuration values such as encoding profiles.</p>
<p>Each source selector can have only one corresponding section in each set of values.
The use of the semi-colon is optional. If it is absent, there is only one section.
If there is only one source selector, but multiple sections in the parameters, then the sections are collapsed
into one and they will apply to all the source flavors in the source selector.
"N to N" means that each section has its own processing configuration.
"1 to N" or "N to 1" means that all the sections are processed the same way,
 but "M to N" where "M &lt;&gt; N" will result in an error.</p>
<p>eg:</p>
<pre><code class="language-xml">&lt;configuration key=&quot;target-flavors&quot;&gt;*/preview&lt;/configuration&gt;
&lt;configuration key=&quot;encoding-profiles&quot;&gt;mp4-low.http;mp4-vga-medium&lt;/configuration&gt;
</code></pre>
<p>All targets are flavored the same way.
Using the example above,
all media are encoded with "mp4-low.http" and "mp4-vga-medium" and
targets are flavored as "presenter/preview" and "presentation/preview"</p>
<pre><code class="language-xml"> &lt;configuration key=&quot;target-tags&quot;&gt;engage-streaming,rss,atom;engage-download,rss,atom&lt;/configuration&gt;
 &lt;configuration key=&quot;encoding-profiles&quot;&gt;mp4-medium.http;mp4-vga-medium&lt;/configuration&gt;
</code></pre>
<p>Each section is tagged individually. Using the example above,
presenter/preview is encoded with "mp4-medium.http" and tagged with "engage-streaming" ,"rss" and "atom",
presentation/preview is encoded with "mp4-vga-medium" and tagged with "engage-download","rss" and "atom".</p>
<p>If presenter/work is to be encoded with "mp4-low.http,mp4-medium.http" and
presentation/work is to be encoded with "mp4-vga-medium,mp4-medium.http",
and the target media are flavored as "presenter/delivery" and "presentation/delivery" respectively,
and all targets are tagged with "engage" and "archive" in addition to the names of the encoding profiles used.</p>
<p>This workflow supports HLS adaptive streaming.
By:</p>
<p>1) Using only H.264/HENV encodings in the encoding profiles.
2) Adding a special encoding profile "multiencode-hls" to the list of encoding profiles.</p>
<p>HLS Playlists are generated as part of the encoding process. Each mp4 is a fragmented MP4.
A variant playlist is created for each mp4 and a master playlist is used to access all the different qualities.</p>
<p>To make sure that stream switching works as expected, state the bitrates explicitly for each of mp4 encoding profiles used.
For advices on how to pick bitrates see:
https://developer.apple.com/documentation/http_live_streaming/hls_authoring_specification_for_apple_devices</p>
<p>For more details on HLS, see:
https://tools.ietf.org/html/rfc8216
https://tools.ietf.org/html/draft-pantos-http-live-streaming-23</p>
<p>Without HLS, it will look like the following.</p>
<h2 id="parameter-table">Parameter Table</h2>
<table>
<thead>
<tr>
<th>configuration keys</th>
<th>example</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>smil-flavor</td>
<td>smil/smil</td>
<td>Specifies the flavor of the new media</td>
</tr>
<tr>
<td>source-flavors</td>
<td>presenter/work<strong>;</strong>presentation/work</td>
<td>Which media should be encoded</td>
</tr>
<tr>
<td>target-flavors</td>
<td>*/delivery</td>
<td>Specifies the flavor of the new media</td>
</tr>
<tr>
<td>target-tags</td>
<td>engage,archive</td>
<td>Specifies the tags of the new media</td>
</tr>
<tr>
<td>encoding-profiles</td>
<td>mp4-low.http,mp4-med.http<strong>;</strong>mp4-vga-med,mp4-med.http</td>
<td>Profiles for each source flavor</td>
</tr>
<tr>
<td>tag-with-profile</td>
<td>true (default to false)</td>
<td>target medium are tagged with corresponding encoding profile Id</td>
</tr>
</tbody>
</table>
<p>With HLS, encoding profiles will look like the following.</p>
<p>|encoding-profiles  | mp4-low.http,mp4-med.http,multiencode-hls<strong>;</strong>mp4-vga-med,mp4-med.http,multiencode-hls | Profiles|</p>
<h2 id="operation-example">Operation Example</h2>
<p>The parameters in the table above will look like this as a workflow operation.</p>
<pre><code class="language-xml">&lt;operation
    id=&quot;process-smil&quot;
    description=&quot;Encoding presenter (camera) video to Flash download&quot;&gt;
  &lt;configurations&gt;
    &lt;configuration key=&quot;smil-flavor&quot;&gt;smil/cutting&lt;/configuration&gt;
    &lt;configuration key=&quot;source-flavors&quot;&gt;presenter/work;presentation/work&lt;/configuration&gt;
    &lt;configuration key=&quot;target-flavors&quot;&gt;*/delivery&lt;/configuration&gt;
    &lt;configuration key=&quot;target-tags&quot;&gt;engage,archive&lt;/configuration&gt;
    &lt;configuration key=&quot;encoding-profiles&quot;&gt;mp4-low.http,mp4-medium.http*;*mp4-vga-medium,mp4-medium.http&lt;/configuration&gt;
    &lt;configuration key=&quot;tag-with-profile&quot;&gt;true&lt;/configuration&gt;
  &lt;/configurations&gt;
&lt;/operation&gt;
</code></pre>
<p>With HLS, encoding profiles line will look like:</p>
<pre><code class="language-xml">&lt;configuration key=&quot;encoding-profiles&quot;&gt;mp4-low.http,mp4-medium.http,multiencode-hls*;*mp4-vga-medium,mp4-medium.http,multiencode-hls&lt;/configuration&gt;
</code></pre>
<h2 id="note-very-important">Note: (Very Important)</h2>
<p>Each encoding section generates all the target media in one FFmpeg call by incorporating relevant parts
of each encoding profile command using complex filters.</p>
<ul>
<li>
<p>Care must be taken that <strong>no complex filters</strong> are used in the encoding profiles used for this workflow,
  as it can cause a conflict and FFmpeg will fail.
  Simple filters (i.e.: -vf, -af , -filter:v, -filter:a) can be used.</p>
</li>
<li>
<p>Encoded target recording are distinguished by the suffix, it is important that <strong>all the encoding profiles
  used have distinct suffixes</strong> or the target video tagging can be wrong, for example:</p>
</li>
</ul>
<pre><code class="language-properties">profile.mp4-vga-medium.http.suffix = -vga-medium.mp4
profile.mp4-medium.http.suffix = -medium.mp4
</code></pre>
<ul>
<li>If using this to process SMIL files generated by the editor in the same workflow,
  be sure to set the "skip-processing" key in the editor to true.</li>
</ul>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../publication-to-workspace-woh/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../publication-to-workspace-woh/" class="btn btn-xs btn-link">
        Publication to Workspace
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../probe-resolution-woh/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../probe-resolution-woh/" class="btn btn-xs btn-link">
        Probe Resolution
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/opencast/opencast/edit/develop/docs/guides/admin/docs/workflowoperationhandlers/process-smil-woh.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>